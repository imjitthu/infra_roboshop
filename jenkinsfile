pipeline {

    agent any

    stages ('Installing RoboShop WebApplication Components') {
        stage ('Installing Databases') {
            parallel {
                stage ('Installing MongoDB') {
                    steps {
                        dir ('tfas-mongo') {
                        withCredentials([aws(accessKeyVariable: 'AWS_ACCESS_KEY_ID', credentialsId: 'awskey', secretKeyVariable: 'AWS_SECRET_ACCESS_KEY')]) {
                        git 'https://github.com/imjitthu/infra_roboshop.git'
                        sh """
                        terraform init
                        """
                        } 
                        sh 'ls'
                        ansiblePlaybook credentialsId: 'DevOps321', installation: 'ansibletool', inventory: 'mongo_inv', playbook: 'mongo.yml'
                    }
                    }
                }
                stage ('Installing MySQL') {
                    steps {
                        withCredentials([aws(accessKeyVariable: 'AWS_ACCESS_KEY_ID', credentialsId: 'awskey', secretKeyVariable: 'AWS_SECRET_ACCESS_KEY')]) {
                        dir ('tfas-mysql') {
                        sh """
                        // terraform init
                        // terraform apply -auto-approve
                        """
                        }
                        } 
                        ansiblePlaybook credentialsId: 'DevOps321', installation: 'ansibletool', inventory: 'mongo_inv', playbook: 'mongo.yml'
                    }
                }
            }
        }
        stage ('Installing Redis and RabbitMQ Server') {
            parallel {
                stage ('Installing Redis Component') {
                    steps {
                        sh 'echo redis'
                    }
                }
                stage ('Installing RabbitmQ Server') {
                    steps {
                        sh 'echo RabbitMQ Server'
                        }
                    }
                }
            }
        stage ('Installing Components: CART, CATALOGUE, USER, SGIPPING, PAYMENT') {
            parallel {
                stage ('Installing CART Component') {
                    steps {
                        sh 'echo CART'
                    }
                }
                stage ('Installing CATALOGUE Component') {
                    steps {
                        sh 'echo CATALOGUE'
                    }
                }
                stage ('Installing USER Component') {
                    steps {
                        sh 'echo USER'
                    }
                }
                stage ('Installing SHIPPING Component') {
                    steps {
                        sh 'echo Shipping'
                    }
                }
                stage ('Installing Payment Component') {
                    steps {
                        sh 'echo Payment'
                    }
                }
            }
        }
        stage ('Installing Roboshop Web Server') {
            steps {
                sh 'echo web Server'
                }
            }
        }
    }